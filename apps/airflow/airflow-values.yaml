# apps/airflow/airflow-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: airflow-values
  namespace: airflow
  labels:
    app.kubernetes.io/part-of: airflow
    app.kubernetes.io/managed-by: flux
data:
  values.yaml: |
    # Bitnami Airflow Helm chart values
    executor: CeleryExecutor

    # Try multiple image override approaches - Bitnami chart may construct tags differently
    # Approach 1: Global settings (standard for Bitnami charts)
    global:
      imageRegistry: docker.io
      imageRepository: bitnamilegacy/airflow
    
    # Approach 2: DefaultImage with full image string attempt
    defaultImage:
      registry: docker.io
      repository: bitnamilegacy/airflow
      # Try providing the full expected tag to see if chart uses it as-is
      tag: "3.0.5"
    
    # Approach 3: Component-level overrides with explicit image
    webserver:
      image:
        registry: docker.io
        repository: bitnamilegacy/airflow
        tag: "3.0.5"

    # Disable built-in database and redis subcharts (using external)
    postgresql:
      enabled: false
    redis:
      enabled: false

    # External database configuration
    externalDatabase:
      host: postgresql.postgres.svc.cluster.local
      port: 5432
      database: airflow
      user: airflow
      existingSecret: airflow-pg-conn-secret
      existingSecretPasswordKey: password

    # External Redis configuration
    externalRedis:
      host: redis-master-master.redis.svc.cluster.local
      port: 6379
      existingSecret: airflow-redis-conn-secret
      existingSecretPasswordKey: redis-password

    # Database migration job configuration
    # For Flux CD (GitOps), Helm hooks don't work, so we need to disable them
    migrateDatabaseJob:
      useHelmHooks: false
      applyCustomEnv: false
      image:
        registry: docker.io
        repository: bitnamilegacy/airflow
        tag: "3.0.5"

    # Secret key for webserver
    secretKey:
      existingSecret: airflow-webserver-secret-key
      existingSecretKey: webserver-secret-key

    # Admin user configuration
    auth:
      username:
        existingSecret: airflow-admin-credentials
        existingSecretKey: username
      password:
        existingSecret: airflow-admin-credentials
        existingSecretKey: password

    # Ingress configuration
    ingress:
      enabled: true
      ingressClassName: nginx
      hostname: airflow.vanir-proxmox.duckdns.org
      path: /
      pathType: Prefix
      tls: false

    # Webserver configuration
    webserver:
      replicas: 2
      image:
        registry: docker.io
        repository: bitnamilegacy/airflow
        tag: "3.0.5"
      livenessProbe:
        enabled: true
        initialDelaySeconds: 60
        periodSeconds: 30
      # readinessProbe - using Bitnami chart defaults to avoid tcpSocket/httpGet conflict

    # Scheduler configuration
    scheduler:
      replicas: 2
      image:
        registry: docker.io
        repository: bitnamilegacy/airflow
        tag: "3.0.5"
      livenessProbe:
        enabled: true
        initialDelaySeconds: 120
        periodSeconds: 30
      readinessProbe:
        enabled: true
        initialDelaySeconds: 60
        periodSeconds: 10

    # Worker configuration
    workers:
      replicas: 2
      image:
        registry: docker.io
        repository: bitnamilegacy/airflow
        tag: "3.0.5"
      terminationGracePeriodSeconds: 600
      livenessProbe:
        enabled: true
        initialDelaySeconds: 120
        periodSeconds: 30
      readinessProbe:
        enabled: true
        initialDelaySeconds: 60
        periodSeconds: 10






   

  