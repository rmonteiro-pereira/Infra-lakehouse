# apps/airflow/airflow-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: airflow-values
  namespace: airflow
  labels:
    app.kubernetes.io/part-of: airflow
    app.kubernetes.io/managed-by: flux
data:
  values.yaml: |
    # Bitnami Airflow Helm chart values
    executor: CeleryExecutor

    # Image configuration - override to use a valid image tag
    image:
      registry: docker.io
      repository: bitnami/airflow
      tag: 3.0.5

    # Disable built-in database and redis subcharts (using external)
    postgresql:
      enabled: false
    redis:
      enabled: false

    # External database configuration
    externalDatabase:
      host: postgresql.postgres.svc.cluster.local
      port: 5432
      database: vanir-postgres
      user: vanir
      existingSecret: airflow-pg-conn-secret
      existingSecretPasswordKey: connection

    # External Redis configuration
    externalRedis:
      host: redis-master.redis.svc.cluster.local
      port: 6379
      existingSecret: airflow-redis-conn-secret
      existingSecretPasswordKey: connection

    # Secret key for webserver
    secretKey:
      existingSecret: airflow-webserver-secret-key
      existingSecretKey: webserver-secret-key

    # Admin user configuration
    auth:
      username:
        existingSecret: airflow-admin-credentials
        existingSecretKey: username
      password:
        existingSecret: airflow-admin-credentials
        existingSecretKey: password

    # Ingress configuration - temporarily disabled to resolve conflict
    ingress:
      enabled: false
      # ingressClassName: nginx
      # hostname: airflow.vanir-proxmox.duckdns.org
      # path: /
      # pathType: Prefix
      # tls: false

    # Webserver configuration
    webserver:
      replicas: 2
      livenessProbe:
        enabled: true
        initialDelaySeconds: 60
        periodSeconds: 30
      # readinessProbe - using Bitnami chart defaults to avoid tcpSocket/httpGet conflict

    # Scheduler configuration
    scheduler:
      replicas: 2
      livenessProbe:
        enabled: true
        initialDelaySeconds: 120
        periodSeconds: 30
      readinessProbe:
        enabled: true
        initialDelaySeconds: 60
        periodSeconds: 10

    # Worker configuration
    workers:
      replicas: 2
      terminationGracePeriodSeconds: 600
      livenessProbe:
        enabled: true
        initialDelaySeconds: 120
        periodSeconds: 30
      readinessProbe:
        enabled: true
        initialDelaySeconds: 60
        periodSeconds: 10






   

  