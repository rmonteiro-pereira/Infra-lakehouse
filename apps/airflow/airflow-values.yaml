apiVersion: v1
kind: ConfigMap
metadata:
  name: airflow-values
  namespace: airflow
  labels:
    app.kubernetes.io/managed-by: flux
data:
  values.yaml: |
    # Core Configuration
    airflow:
      image:
        repository: apache/airflow
        tag: 2.6.3
        pullPolicy: IfNotPresent
      
      executor: CeleryExecutor
      config:
        AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "False"
        AIRFLOW__CORE__LOAD_EXAMPLES: "False"
        AIRFLOW__CORE__FERNET_KEY: ${FERNET_KEY}  # Will be replaced by secret

    # Database (PostgreSQL)
    postgresql:
      enabled: true
      postgresqlUsername: airflow
      postgresqlDatabase: airflow
      persistence:
        enabled: true
        size: 50Gi
        storageClass: standard

    # Redis (Celery Broker) - Adjust based on chart v1.13.0 schema
    redis:
      enabled: true
      # 'architecture' and 'master' might not be top-level keys.
      # Persistence might be configured like this:
      persistence:
         enabled: true
         size: 20Gi
      # Check chart docs for correct structure for standalone/HA

    # Web Server
    webserver:
      replicas: 2
      # ... other webserver config ...

    # Workers
    workers:
      replicas: 4
      # ... other worker config ...
      persistence:
        enabled: true
        size: 20Gi

    # Monitoring
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
        namespace: monitoring
        interval: 30s
        labels:
          release: kube-prometheus-stack

    # Flower (Celery UI) - Adjust based on chart v1.13.0 schema
    flower:
      enabled: true
      # 'replicas' might be directly under 'flower' or nested differently
      # replicas: 1 # Check if this key is valid here
      # 'ingress' might be nested or named differently
      # ingress: # Check if this structure is valid
      #   enabled: true
      #   hostname: flower.airflow.example.com
      #   annotations:
      #     cert-manager.io/cluster-issuer: letsencrypt-prod