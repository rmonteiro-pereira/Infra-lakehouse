# apps/airflow/airflow-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: airflow-values
  namespace: airflow
  labels:
    app.kubernetes.io/part-of: airflow
    app.kubernetes.io/managed-by: flux
data:
  values.yaml: |
    # Top-level Helm chart values start here
    executor: CeleryExecutor

    redis:
      enabled: false
    postgresql:
      enabled: false

    # This 'data' block is for Airflow's internal data configurations
    # It is a top-level key in the Helm chart's values.
    data:
      metadataSecretName: airflow-pg-conn-secret
      metadataSecretKey: connection
      brokerUrlSecretName: airflow-redis-conn-secret
      brokerUrlSecretKey: connection

    # Other top-level configurations
    users:
      - role: Admin
        usernameFromSecretRef:
          name: airflow-admin-credentials
          key: username
        passwordSecretRef:
          name: airflow-admin-credentials
          key: password

    webserverSecretKeySecretName: airflow-webserver-secret-key

    # Ingress is a top-level configuration
    ingress:
      web:
        enabled: true
        ingressClassName: "nginx"
        host: airflow.vanir-proxmox.duckdns.org
        path: /
        pathType: Prefix
      # tls:
      #   enabled: false



    webserver:
      replicas: 2
      livenessProbe:
        initialDelaySeconds: 60
        periodSeconds: 30
      waitForMigrations:
        enabled: true

    scheduler:
      replicas: 2
      livenessProbe:
        initialDelaySeconds: 120
        periodSeconds: 30

    workers:
      replicas: 2
      terminationGracePeriodSeconds: 600
    
    createUserJob:
      useHelmHooks: false
      applyCustomEnv: false
    migrateDatabaseJob:
      useHelmHooks: false
      applyCustomEnv: false






   

  